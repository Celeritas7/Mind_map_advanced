<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mind Map App v1</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
/* ============================================
   RESET & BASE
   ============================================ */
* { margin:0; padding:0; box-sizing:border-box; }
body {
  font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
  background:#f0f4f8;
  min-height:100vh;
  overflow:hidden;
}

/* ============================================
   HEADER
   ============================================ */
.header {
  background:linear-gradient(135deg,#1a1a2e 0%,#16213e 100%);
  color:white;
  padding:10px 15px;
  display:flex;
  align-items:center;
  gap:10px;
  box-shadow:0 2px 10px rgba(0,0,0,0.3);
  flex-wrap:wrap;
  position:relative;
  z-index:100;
}
.header h1 {
  font-size:16px;
  font-weight:600;
  background:linear-gradient(90deg,#00d9ff,#00ff88);
  -webkit-background-clip:text;
  -webkit-text-fill-color:transparent;
  background-clip:text;
}
.header select {
  padding:6px 12px;
  font-size:12px;
  border:none;
  border-radius:6px;
  background:white;
  cursor:pointer;
  min-width:120px;
}
.header label {
  font-size:11px;
  color:#8892b0;
}
.control-group {
  display:flex;
  align-items:center;
  gap:5px;
  background:rgba(255,255,255,0.08);
  padding:4px 10px;
  border-radius:6px;
}

/* ============================================
   BUTTONS
   ============================================ */
.header-btn {
  padding:6px 10px;
  font-size:11px;
  border:none;
  border-radius:6px;
  cursor:pointer;
  background:#3498db;
  color:white;
  transition:all 0.2s;
  flex-shrink:0;
}
.header-btn:hover { background:#2980b9; transform:translateY(-1px); }
.header-btn.save-btn { background:#27ae60; }
.header-btn.save-btn:hover { background:#1e8449; }
.header-btn.back-btn {
  background:#34495e;
  display:flex;
  align-items:center;
  gap:5px;
}
.header-btn.back-btn:hover { background:#2c3e50; }
.admin-only { display:none; }
.admin-only.visible { display:inline-flex; align-items:center; }
.login-btn {
  background:#e74c3c;
  display:flex;
  align-items:center;
  gap:5px;
}
.login-btn:hover { background:#c0392b; }
.user-badge {
  background:rgba(39,174,96,0.3);
  color:#27ae60;
  padding:4px 8px;
  border-radius:4px;
  font-size:10px;
  display:flex;
  align-items:center;
  gap:5px;
}
.btn {
  padding:10px 20px;
  font-size:13px;
  font-weight:500;
  border:none;
  border-radius:6px;
  cursor:pointer;
  transition:all 0.2s;
}
.btn-primary { background:#3498db; color:white; }
.btn-primary:hover { background:#2980b9; }
.btn-secondary { background:#ecf0f1; color:#333; }
.btn-secondary:hover { background:#ddd; }
.btn-danger { background:#e74c3c; color:white; }
.btn-danger:hover { background:#c0392b; }

/* ============================================
   STATUS & INDICATORS
   ============================================ */
.status-text { font-size:11px; padding:4px 8px; border-radius:4px; }
.status-text.loading { color:#f39c12; }
.status-text.error { color:#e74c3c; }
.status-text.success { color:#27ae60; }
.db-indicator {
  background:rgba(39,174,96,0.2);
  color:#27ae60;
  padding:4px 8px;
  border-radius:4px;
  font-size:10px;
  display:flex;
  align-items:center;
  gap:4px;
}
.db-indicator.disconnected { background:rgba(231,76,60,0.2); color:#e74c3c; }
.db-dot {
  width:6px; height:6px; border-radius:50%;
  background:#27ae60; animation:pulse 2s infinite;
}
.db-indicator.disconnected .db-dot { background:#e74c3c; animation:none; }
@keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }

/* ============================================
   HOME PAGE - PROJECT CARDS
   ============================================ */
.home-page {
  display:none; min-height:calc(100vh - 50px);
  padding:30px; overflow-y:auto;
  background:linear-gradient(135deg,#f5f7fa 0%,#e4e8ec 100%);
}
.home-page.show { display:block; }
.home-header { text-align:center; margin-bottom:30px; }
.home-header h2 { font-size:28px; color:#2c3e50; margin-bottom:8px; }
.home-header p { color:#7f8c8d; font-size:14px; }
.projects-grid {
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(280px,1fr));
  gap:20px; max-width:1400px; margin:0 auto;
}
.project-card {
  background:white; border-radius:16px; padding:20px;
  box-shadow:0 4px 20px rgba(0,0,0,0.08);
  cursor:pointer; transition:all 0.3s ease;
  position:relative; overflow:hidden; border:2px solid transparent;
}
.project-card:hover { transform:translateY(-5px); box-shadow:0 8px 30px rgba(0,0,0,0.12); }
.project-card.hidden-project { opacity:0.6; border:2px dashed #bdc3c7; }
.project-card-color-bar { position:absolute; top:0; left:0; right:0; height:5px; }
.project-card-header { display:flex; align-items:center; gap:15px; margin-bottom:12px; }
.project-card-icon { font-size:40px; line-height:1; }
.project-card-title h3 { font-size:18px; color:#2c3e50; margin-bottom:4px; }
.project-card-title .assembly-count { font-size:12px; color:#95a5a6; }
.project-card-description { font-size:13px; color:#7f8c8d; line-height:1.5; margin-bottom:15px; min-height:40px; }
.project-card-footer {
  display:flex; align-items:center; justify-content:space-between;
  padding-top:12px; border-top:1px solid #ecf0f1;
}
.project-card-actions button {
  padding:6px 10px; font-size:11px; border:none; border-radius:6px; cursor:pointer; margin-left:5px;
}
.project-edit-btn { background:#3498db; color:white; }
.project-edit-btn:hover { background:#2980b9; }
.project-delete-btn { background:#e74c3c; color:white; }
.project-delete-btn:hover { background:#c0392b; }
.visibility-toggle { display:flex; align-items:center; gap:6px; font-size:11px; color:#7f8c8d; }
.visibility-toggle input[type="checkbox"] { display:none; }
.visibility-toggle label { cursor:pointer; display:flex; align-items:center; gap:4px; }
.toggle-switch {
  width:36px; height:20px; background:#bdc3c7; border-radius:10px;
  position:relative; transition:background 0.3s;
}
.toggle-switch::after {
  content:''; position:absolute; width:16px; height:16px;
  background:white; border-radius:50%; top:2px; left:2px; transition:transform 0.3s;
}
.visibility-toggle input:checked + label .toggle-switch { background:#27ae60; }
.visibility-toggle input:checked + label .toggle-switch::after { transform:translateX(16px); }
.project-card.add-card {
  border:2px dashed #bdc3c7; background:rgba(255,255,255,0.5);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  min-height:200px; color:#95a5a6;
}
.project-card.add-card:hover { border-color:#3498db; color:#3498db; }
.project-card.add-card .add-icon { font-size:48px; margin-bottom:10px; }

/* ============================================
   ASSEMBLIES PAGE
   ============================================ */
.assemblies-page { display:none; min-height:calc(100vh - 50px); padding:30px; overflow-y:auto; }
.assemblies-page.show { display:block; }
.assemblies-header {
  display:flex; align-items:center; gap:20px; margin-bottom:30px;
  max-width:1400px; margin-left:auto; margin-right:auto;
}
.assemblies-header .project-icon { font-size:50px; }
.assemblies-header-info h2 { font-size:24px; color:#2c3e50; margin-bottom:4px; }
.assemblies-header-info p { font-size:13px; color:#7f8c8d; }
.assemblies-grid {
  display:grid; grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:15px; max-width:1400px; margin:0 auto;
}
.assembly-card {
  background:white; border-radius:12px; padding:16px;
  box-shadow:0 2px 12px rgba(0,0,0,0.06);
  cursor:pointer; transition:all 0.2s ease; border-left:4px solid;
}
.assembly-card:hover { transform:translateY(-3px); box-shadow:0 6px 20px rgba(0,0,0,0.1); }
.assembly-card.hidden-assembly { opacity:0.6; border-style:dashed; }
.assembly-card h4 { font-size:15px; color:#2c3e50; margin-bottom:6px; }
.assembly-card .node-count { font-size:11px; color:#95a5a6; }
.assembly-card-footer {
  display:flex; justify-content:space-between; align-items:center;
  margin-top:12px; padding-top:10px; border-top:1px solid #ecf0f1;
}
.assembly-card.add-card {
  border:2px dashed #bdc3c7; background:rgba(255,255,255,0.5);
  display:flex; flex-direction:column; align-items:center; justify-content:center;
  min-height:100px; color:#95a5a6; border-left:2px dashed #bdc3c7;
}
.assembly-card.add-card:hover { border-color:#3498db; color:#3498db; }

/* ============================================
   TREE VIEW
   ============================================ */
.main-container { display:flex; height:calc(100vh - 90px); }
.tree-container { flex:1; overflow:auto; background:#fafafa; position:relative; }
svg { display:block; }

/* Legend */
.legend {
  background:white; padding:8px 15px; display:flex; gap:15px;
  align-items:center; border-bottom:1px solid #e0e0e0; flex-wrap:wrap; font-size:10px;
}
.legend-section { display:flex; gap:8px; align-items:center; }
.legend-title { font-weight:600; color:#333; }
.legend-item { display:flex; align-items:center; gap:4px; color:#666; }
.legend-color { width:14px; height:14px; border-radius:3px; border:1px solid rgba(0,0,0,0.1); }
.legend-divider { width:1px; height:20px; background:#ddd; }

/* Nodes */
.node { cursor:grab; }
.node:active { cursor:grabbing; }
.node-shape { transition:filter 0.2s; }
.node:hover .node-shape { filter:brightness(0.95); }
.node.selected .node-shape { filter:drop-shadow(0 0 8px rgba(52,152,219,0.8)); }
.node-label { pointer-events:none; font-weight:500; }

/* Links */
.link {
  fill:none !important; stroke-linecap:round; stroke-linejoin:round;
  cursor:pointer; stroke-width:1.5px;
}
.link:hover { stroke-width:2.5px !important; }

/* Status dot on nodes */
.status-dot { stroke-width:1.5px; pointer-events:none; }

/* ============================================
   SIDE PANEL
   ============================================ */
.side-panel {
  width:0; background:white; border-left:1px solid #e0e0e0;
  overflow:hidden; transition:width 0.3s ease; display:flex; flex-direction:column;
}
.side-panel.open { width:320px; }
.side-panel-header {
  padding:15px; background:#f8f9fa; border-bottom:1px solid #e0e0e0;
  display:flex; justify-content:space-between; align-items:center;
}
.side-panel-title { font-size:14px; font-weight:600; color:#333; }
.side-panel-close {
  background:none; border:none; font-size:18px; cursor:pointer;
  color:#666; padding:4px 8px; border-radius:4px;
}
.side-panel-close:hover { background:#eee; }
.side-panel-content { flex:1; overflow-y:auto; padding:15px; }
.side-panel-footer { padding:15px; border-top:1px solid #e0e0e0; display:flex; gap:10px; }

/* Forms */
.form-group { margin-bottom:15px; }
.form-label {
  display:block; font-size:11px; font-weight:600; color:#666;
  margin-bottom:5px; text-transform:uppercase; letter-spacing:0.5px;
}
.form-input,.form-select,.form-textarea {
  width:100%; padding:10px 12px; font-size:13px;
  border:1px solid #ddd; border-radius:6px; transition:border-color 0.2s,box-shadow 0.2s;
}
.form-input:focus,.form-select:focus,.form-textarea:focus {
  outline:none; border-color:#3498db; box-shadow:0 0 0 3px rgba(52,152,219,0.15);
}
.form-textarea { min-height:80px; resize:vertical; }
.form-row { display:flex; gap:10px; }
.form-row .form-group { flex:1; }

/* ============================================
   CONTEXT MENU
   ============================================ */
.context-menu {
  display:none; position:fixed; background:white; border-radius:8px;
  box-shadow:0 4px 20px rgba(0,0,0,0.2); min-width:180px;
  z-index:1000; overflow:hidden; animation:menuFadeIn 0.15s ease;
}
@keyframes menuFadeIn { from{opacity:0;transform:scale(0.95)} to{opacity:1;transform:scale(1)} }
.context-menu.show { display:block; }
.context-menu-item {
  padding:10px 16px; cursor:pointer; display:flex; align-items:center;
  gap:10px; font-size:13px; color:#333; transition:background 0.15s;
}
.context-menu-item:hover { background:#f5f5f5; }
.context-menu-item.danger { color:#e74c3c; }
.context-menu-item.danger:hover { background:#fef0f0; }
.context-menu-divider { height:1px; background:#eee; margin:4px 0; }

/* ============================================
   MODAL
   ============================================ */
.modal-overlay {
  display:none; position:fixed; top:0; left:0; right:0; bottom:0;
  background:rgba(0,0,0,0.5); z-index:1500; align-items:center; justify-content:center;
}
.modal-overlay.show { display:flex; }
.modal {
  background:white; border-radius:12px; width:90%; max-width:450px;
  box-shadow:0 10px 40px rgba(0,0,0,0.3); animation:modalIn 0.2s ease;
}
@keyframes modalIn { from{opacity:0;transform:scale(0.9)} to{opacity:1;transform:scale(1)} }
.modal-header { padding:20px; border-bottom:1px solid #eee; }
.modal-title { font-size:18px; font-weight:600; color:#333; }
.modal-body { padding:20px; }
.modal-footer { padding:15px 20px; border-top:1px solid #eee; display:flex; justify-content:flex-end; gap:10px; }

/* ============================================
   TOAST
   ============================================ */
.toast-container {
  position:fixed; bottom:20px; right:20px; z-index:2000;
  display:flex; flex-direction:column; gap:10px;
}
.toast {
  padding:12px 20px; background:#333; color:white; border-radius:8px;
  box-shadow:0 4px 12px rgba(0,0,0,0.2); display:flex; align-items:center;
  gap:10px; animation:toastIn 0.3s ease; max-width:350px;
}
.toast.success { background:#27ae60; }
.toast.error { background:#e74c3c; }
.toast.warning { background:#f39c12; }
@keyframes toastIn { from{opacity:0;transform:translateX(100px)} to{opacity:1;transform:translateX(0)} }

/* ============================================
   LOADING
   ============================================ */
.loading-overlay {
  display:none; position:absolute; top:0; left:0; right:0; bottom:0;
  background:rgba(255,255,255,0.8); z-index:500; align-items:center; justify-content:center;
}
.loading-overlay.show { display:flex; }
.spinner {
  width:40px; height:40px; border:3px solid #eee;
  border-top-color:#3498db; border-radius:50%; animation:spin 0.8s linear infinite;
}
@keyframes spin { to{transform:rotate(360deg)} }

/* ============================================
   EMOJI & COLOR PICKER
   ============================================ */
.emoji-picker {
  display:grid; grid-template-columns:repeat(8,1fr); gap:5px;
  max-height:200px; overflow-y:auto; padding:10px; background:#f8f9fa; border-radius:8px;
}
.emoji-picker button { font-size:24px; padding:8px; border:none; background:white; border-radius:6px; cursor:pointer; }
.emoji-picker button:hover { background:#e8e8e8; }
.emoji-picker button.selected { background:#3498db; }
.color-picker {
  display:grid; grid-template-columns:repeat(6,1fr); gap:8px;
  padding:10px; background:#f8f9fa; border-radius:8px;
}
.color-picker button { width:40px; height:40px; border:3px solid transparent; border-radius:8px; cursor:pointer; }
.color-picker button.selected { border-color:#2c3e50; }

/* ============================================
   CHATBOT
   ============================================ */
.chat-fab {
  position:fixed; bottom:20px; right:20px; width:60px; height:60px;
  border-radius:50%; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  border:none; color:white; font-size:24px; cursor:pointer;
  box-shadow:0 4px 20px rgba(102,126,234,0.4); z-index:150;
  transition:transform 0.2s,box-shadow 0.2s;
}
.chat-fab:hover { transform:scale(1.1); box-shadow:0 6px 25px rgba(102,126,234,0.5); }
.chat-panel {
  position:fixed; bottom:90px; right:20px; width:380px; max-height:500px;
  background:white; border-radius:16px; box-shadow:0 10px 40px rgba(0,0,0,0.2);
  display:none; flex-direction:column; z-index:150; overflow:hidden;
}
.chat-panel.open { display:flex; }
.chat-header {
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  color:white; padding:15px 20px; display:flex; justify-content:space-between; align-items:center;
}
.chat-header h3 { font-size:16px; font-weight:600; display:flex; align-items:center; gap:8px; }
.chat-close { background:none; border:none; color:white; font-size:20px; cursor:pointer; opacity:0.8; }
.chat-close:hover { opacity:1; }
.chat-quick-actions {
  display:flex; gap:6px; padding:10px; background:#f8f9fa;
  border-bottom:1px solid #e9ecef; flex-wrap:wrap;
}
.quick-btn {
  padding:6px 12px; font-size:11px; background:white; border:1px solid #dee2e6;
  border-radius:15px; cursor:pointer; transition:all 0.2s;
}
.quick-btn:hover { background:#667eea; color:white; border-color:#667eea; }
.chat-messages { flex:1; overflow-y:auto; padding:15px; max-height:300px; min-height:200px; }
.chat-message { margin-bottom:12px; display:flex; }
.chat-message.user { justify-content:flex-end; }
.chat-message.assistant { justify-content:flex-start; }
.chat-bubble { max-width:85%; padding:10px 14px; border-radius:16px; font-size:13px; line-height:1.5; }
.chat-bubble.user {
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  color:white; border-bottom-right-radius:4px;
}
.chat-bubble.assistant { background:#f1f3f4; color:#333; border-bottom-left-radius:4px; }
.chat-input-area {
  display:flex; gap:8px; padding:12px; border-top:1px solid #e9ecef; background:#f8f9fa;
}
.chat-input-area input {
  flex:1; padding:10px 15px; border:1px solid #dee2e6;
  border-radius:20px; font-size:13px; outline:none;
}
.chat-input-area input:focus { border-color:#667eea; }
.chat-send {
  width:40px; height:40px; border-radius:50%;
  background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
  border:none; color:white; font-size:16px; cursor:pointer;
}
.chat-send:hover { opacity:0.9; }
  </style>
</head>
<body>

<!-- ============================================ -->
<!-- HEADER -->
<!-- ============================================ -->
<div class="header">
  <h1>üß† Mind Map App v1</h1>
  <button class="header-btn back-btn" id="backBtn" style="display:none;" onclick="navigateBack()">‚Üê Back</button>
  <div id="breadcrumb" class="control-group" style="display:none;">
    <span id="breadcrumbText" style="font-size:12px;color:#8892b0;"></span>
  </div>

  <!-- Tree controls -->
  <div id="treeControlsWrapper" style="display:none;">
    <div class="control-group">
      <label>Mind Map:</label>
      <select id="assemblySelect" onchange="onAssemblyChange()">
        <option value="">Loading...</option>
      </select>
      <button class="header-btn admin-only" style="padding:4px 8px;margin-left:4px;" onclick="createNewAssemblyInTree()" title="New Mind Map">‚ûï</button>
      <button class="header-btn admin-only" style="padding:4px 8px;background:#f39c12;" onclick="renameCurrentAssembly()" title="Rename">‚úèÔ∏è</button>
      <button class="header-btn admin-only" style="padding:4px 8px;background:#e74c3c;" onclick="confirmDeleteCurrentAssembly()" title="Delete">üóëÔ∏è</button>
    </div>
  </div>

  <div id="treeControls" style="display:none;">
    <div class="control-group">
      <label>Color:</label>
      <select id="colorMode" onchange="renderGraph()">
        <option value="level">Level</option>
        <option value="status">Status</option>
        <option value="priority">Priority</option>
      </select>
    </div>
    <button class="header-btn admin-only" onclick="refreshLayout()">üîÑ</button>
    <button class="header-btn save-btn admin-only" onclick="saveAllPositions()">üíæ Save</button>
  </div>

  <span id="statusIndicator" class="status-text"></span>

  <div style="margin-left:auto;display:flex;align-items:center;gap:10px;">
    <div id="dbIndicator" class="db-indicator">
      <span class="db-dot"></span><span>Supabase</span>
    </div>
    <div id="loginArea">
      <button class="header-btn login-btn" id="loginBtn" onclick="handleLogin()">
        <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width:14px;height:14px;"> Sign In
      </button>
    </div>
    <div id="userBadge" class="user-badge" style="display:none;">
      <span id="userName"></span>
      <button class="header-btn" style="padding:2px 6px;font-size:9px;" onclick="handleLogout()">‚úï</button>
    </div>
  </div>
</div>

<!-- ============================================ -->
<!-- HOME PAGE - PROJECTS -->
<!-- ============================================ -->
<div class="home-page show" id="homePage">
  <div class="home-header">
    <h2>üß† My Projects</h2>
    <p>Select a project to view its mind maps</p>
  </div>
  <div class="projects-grid" id="projectsGrid"></div>
</div>

<!-- ============================================ -->
<!-- ASSEMBLIES PAGE -->
<!-- ============================================ -->
<div class="assemblies-page" id="assembliesPage">
  <div class="assemblies-header" id="assembliesHeader">
    <span class="project-icon" id="currentProjectIcon">üß†</span>
    <div class="assemblies-header-info">
      <h2 id="currentProjectName">Project Name</h2>
      <p id="currentProjectDesc">Project description</p>
    </div>
  </div>
  <div class="assemblies-grid" id="assembliesGrid"></div>
</div>

<!-- ============================================ -->
<!-- TREE VIEW PAGE -->
<!-- ============================================ -->
<div id="treePage" style="display:none;">
  <div class="legend">
    <div class="legend-section">
      <span class="legend-title">Status:</span>
      <div class="legend-item"><div class="legend-color" style="background:#27ae60;"></div>Done</div>
      <div class="legend-item"><div class="legend-color" style="background:#f1c40f;"></div>In Progress</div>
      <div class="legend-item"><div class="legend-color" style="background:#bdc3c7;"></div>Not Started</div>
      <div class="legend-item"><div class="legend-color" style="background:#e74c3c;"></div>Blocked</div>
    </div>
    <div class="legend-divider"></div>
    <div class="legend-section">
      <span class="legend-title">Priority:</span>
      <div class="legend-item"><div class="legend-color" style="background:#e74c3c;"></div>High</div>
      <div class="legend-item"><div class="legend-color" style="background:#f39c12;"></div>Medium</div>
      <div class="legend-item"><div class="legend-color" style="background:#3498db;"></div>Low</div>
    </div>
    <div class="legend-divider"></div>
    <div class="legend-section admin-only" id="legendTips">
      <span style="color:#666;font-size:9px;">üí° Right-click nodes for options | Drag to reposition</span>
    </div>
  </div>

  <div class="main-container">
    <div class="tree-container" id="treeContainer">
      <svg id="treeSvg"></svg>
      <div class="loading-overlay" id="loadingOverlay"><div class="spinner"></div></div>
    </div>
    <div class="side-panel" id="sidePanel">
      <div class="side-panel-header">
        <span class="side-panel-title" id="panelTitle">Edit Node</span>
        <button class="side-panel-close" onclick="closeSidePanel()">√ó</button>
      </div>
      <div class="side-panel-content" id="panelContent"></div>
      <div class="side-panel-footer" id="panelFooter"></div>
    </div>
  </div>
  <div class="context-menu" id="contextMenu"></div>
</div>

<!-- Modal -->
<div class="modal-overlay" id="modalOverlay">
  <div class="modal">
    <div class="modal-header"><div class="modal-title" id="modalTitle">Confirm</div></div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer" id="modalFooter"></div>
  </div>
</div>

<!-- Toast -->
<div class="toast-container" id="toastContainer"></div>

<!-- Chatbot -->
<button class="chat-fab" onclick="toggleChatPanel()" title="Mind Map Assistant">ü§ñ</button>
<div class="chat-panel" id="chatPanel">
  <div class="chat-header">
    <h3>ü§ñ Mind Map Assistant</h3>
    <button class="chat-close" onclick="closeChatPanel()">√ó</button>
  </div>
  <div class="chat-quick-actions">
    <button class="quick-btn" onclick="quickAction('status')">üìä Status</button>
    <button class="quick-btn" onclick="quickAction('blocked')">üö´ Blocked</button>
    <button class="quick-btn" onclick="quickAction('progress')">üìà Progress</button>
    <button class="quick-btn" onclick="quickAction('next')">üöÄ What's Next</button>
  </div>
  <div class="chat-messages" id="chatMessages">
    <div class="chat-message assistant">
      <div class="chat-bubble assistant">
        üëã Hi! I'm your Mind Map Assistant. I can help with status, blocked items, progress, and suggestions. Try the quick buttons!
      </div>
    </div>
  </div>
  <div class="chat-input-area">
    <input type="text" id="chatInput" placeholder="Ask about your mind map..." onkeypress="if(event.key==='Enter')sendChatMessage()">
    <button class="chat-send" onclick="sendChatMessage()">‚û§</button>
  </div>
</div>

<script>
// ============================================================
// CONFIGURATION
// ============================================================
const SUPABASE_URL = 'https://wylxvmkcrexwfpjpbhyy.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Ind5bHh2bWtjcmV4d2ZwanBiaHl5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg2MzkxMDYsImV4cCI6MjA4NDIxNTEwNn0.6Bxo42hx4jwlJGWnfjiTpiDUsYfc1QLTN3YtrU1efak';
const GOOGLE_CLIENT_ID = '960816882472-b3qjf15ehvab7mcuvf8154tveoub4sic.apps.googleusercontent.com';
const ADMIN_EMAIL = 'mangaonkaraniket@gmail.com';

const PROJECT_EMOJIS = ['üß†','üìã','üí°','üéØ','üöÄ','‚≠ê','üìå','üî¨','üé®','üìä','üõ†Ô∏è','üíª','üì¶','‚öôÔ∏è','üóÇÔ∏è','üìê','üîß','üèóÔ∏è','üìù','ü§ñ','üåü','üîç','üì±','üñ•Ô∏è'];
const PROJECT_COLORS = [
  {name:'Blue',value:'#3498db'},{name:'Green',value:'#27ae60'},{name:'Purple',value:'#9b59b6'},
  {name:'Red',value:'#e74c3c'},{name:'Orange',value:'#f39c12'},{name:'Teal',value:'#1abc9c'},
  {name:'Pink',value:'#e91e63'},{name:'Yellow',value:'#f1c40f'},{name:'Slate',value:'#607d8b'},
  {name:'Brown',value:'#795548'},{name:'Indigo',value:'#3f51b5'},{name:'Cyan',value:'#00bcd4'}
];

const LEVEL_COLORS = ['#a5d6a7','#e1bee7','#b3e5fc','#c8e6c9','#fff9c4','#ffe0b2','#ffcdd2','#e8e8e8'];
const STATUS_COLORS = {
  DONE:{fill:'#27ae60',bg:'#d5f5e3'},
  IN_PROGRESS:{fill:'#f1c40f',bg:'#fef9e7'},
  NOT_STARTED:{fill:'#bdc3c7',bg:'#f4f6f6'},
  BLOCKED:{fill:'#e74c3c',bg:'#fdedec'}
};
const PRIORITY_COLORS = { HIGH:'#e74c3c', MEDIUM:'#f39c12', LOW:'#3498db' };

// ============================================================
// STATE
// ============================================================
const db = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let isAdmin = false;
let googleUser = null;
let currentPage = 'home'; // home | assemblies | tree
let currentProject = null;
let currentAssemblyId = null;
let currentAssemblyName = '';
let projects = [];
let assemblies = [];
let nodes = [];
let links = [];
let simulation = null;
let selectedNode = null;

// ============================================================
// INIT
// ============================================================
async function init() {
  const connected = await testConnection();
  updateDbIndicator(connected);
  if (connected) {
    await loadProjects();
  }
  initGoogleAuth();
}

async function testConnection() {
  try {
    const { data, error } = await db.from('mind_map_app_projects').select('id').limit(1);
    return !error;
  } catch(e) { return false; }
}

function updateDbIndicator(ok) {
  const el = document.getElementById('dbIndicator');
  if (ok) el.classList.remove('disconnected');
  else el.classList.add('disconnected');
}

// ============================================================
// AUTH (Google)
// ============================================================
function initGoogleAuth() {
  try {
    google.accounts.id.initialize({
      client_id: GOOGLE_CLIENT_ID,
      callback: handleGoogleCallback
    });
  } catch(e) { console.log('Google Auth init delayed'); }
}

function handleLogin() {
  try { google.accounts.id.prompt(); } catch(e) { showToast('Google Auth not loaded','error'); }
}

function handleGoogleCallback(response) {
  const payload = JSON.parse(atob(response.credential.split('.')[1]));
  googleUser = payload;
  isAdmin = payload.email === ADMIN_EMAIL;
  document.getElementById('loginArea').style.display = 'none';
  document.getElementById('userBadge').style.display = 'flex';
  document.getElementById('userName').textContent = payload.name;
  updateAdminUI();
  showToast(`Welcome ${payload.given_name}!`, 'success');
}

function handleLogout() {
  googleUser = null;
  isAdmin = false;
  document.getElementById('loginArea').style.display = 'block';
  document.getElementById('userBadge').style.display = 'none';
  updateAdminUI();
}

function updateAdminUI() {
  document.querySelectorAll('.admin-only').forEach(el => {
    el.classList.toggle('visible', isAdmin);
  });
}

// ============================================================
// UI HELPERS
// ============================================================
function showToast(message, type='info') {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function showModal(title, bodyHtml, buttons) {
  document.getElementById('modalTitle').textContent = title;
  document.getElementById('modalBody').innerHTML = bodyHtml;
  const footer = document.getElementById('modalFooter');
  footer.innerHTML = '';
  buttons.forEach(b => {
    const btn = document.createElement('button');
    btn.className = `btn ${b.class}`;
    btn.textContent = b.label;
    btn.onclick = b.action;
    footer.appendChild(btn);
  });
  document.getElementById('modalOverlay').classList.add('show');
}

function hideModal() { document.getElementById('modalOverlay').classList.remove('show'); }
function escapeHtml(str) { const d=document.createElement('div'); d.textContent=str; return d.innerHTML; }
function setStatus(text, cls='') {
  const el=document.getElementById('statusIndicator');
  el.textContent=text; el.className='status-text'+(cls?' '+cls:'');
}
function showLoading(show) { document.getElementById('loadingOverlay')?.classList.toggle('show',show); }

// ============================================================
// NAVIGATION
// ============================================================
function navigateTo(page) {
  currentPage = page;
  document.getElementById('homePage').classList.toggle('show', page==='home');
  document.getElementById('assembliesPage').classList.toggle('show', page==='assemblies');
  document.getElementById('treePage').style.display = page==='tree'?'block':'none';
  document.getElementById('backBtn').style.display = page==='home'?'none':'inline-flex';
  document.getElementById('treeControlsWrapper').style.display = page==='tree'?'inline-flex':'none';
  document.getElementById('treeControls').style.display = page==='tree'?'inline-flex':'none';
  document.getElementById('breadcrumb').style.display = page!=='home'?'inline-flex':'none';
  updateBreadcrumb();
}

function navigateBack() {
  if (currentPage==='tree') { navigateTo('assemblies'); closeSidePanel(); }
  else if (currentPage==='assemblies') { navigateTo('home'); currentProject=null; }
}

function updateBreadcrumb() {
  let text = '';
  if (currentPage==='assemblies' && currentProject) text = currentProject.name;
  if (currentPage==='tree' && currentProject) text = `${currentProject.name} / ${currentAssemblyName}`;
  document.getElementById('breadcrumbText').textContent = text;
}

// ============================================================
// PROJECTS
// ============================================================
async function loadProjects() {
  try {
    let query = db.from('mind_map_app_projects').select('*').order('name');
    if (!isAdmin) query = query.eq('is_visible', true);
    const { data, error } = await query;
    if (error) throw error;
    projects = data || [];
    renderProjects();
  } catch(e) { console.error('Load projects error:', e); }
}

function renderProjects() {
  const grid = document.getElementById('projectsGrid');
  let html = '';
  let displayProjects = isAdmin ? [...projects] : projects.filter(p=>p.is_visible);
  if (isAdmin) displayProjects.sort((a,b) => (a.is_visible===b.is_visible)?0:(a.is_visible?-1:1));

  for (const p of displayProjects) {
    const hidden = !p.is_visible;
    html += `
      <div class="project-card ${hidden?'hidden-project':''}" onclick="openProject('${p.id}')">
        <div class="project-card-color-bar" style="background:${p.color||'#3498db'}"></div>
        <div class="project-card-header">
          <span class="project-card-icon">${p.icon||'üß†'}</span>
          <div class="project-card-title">
            <h3>${escapeHtml(p.name)}</h3>
            <span class="assembly-count" id="pCount_${p.id}">Loading...</span>
          </div>
        </div>
        <div class="project-card-description">${escapeHtml(p.description||'No description')}</div>
        <div class="project-card-footer">
          ${isAdmin?`
            <div class="visibility-toggle" onclick="event.stopPropagation()">
              <input type="checkbox" id="pVis_${p.id}" ${p.is_visible?'checked':''} onchange="toggleProjectVisibility('${p.id}',this.checked)">
              <label for="pVis_${p.id}"><span class="toggle-switch"></span></label>
            </div>
            <div class="project-card-actions">
              <button class="project-edit-btn" onclick="event.stopPropagation();editProject('${p.id}')">‚úèÔ∏è</button>
              <button class="project-delete-btn" onclick="event.stopPropagation();confirmDeleteProject('${p.id}')">üóëÔ∏è</button>
            </div>
          `:'<span></span>'}
        </div>
      </div>`;
  }

  if (isAdmin) {
    html += `<div class="project-card add-card" onclick="createNewProject()">
      <span class="add-icon">‚ûï</span><span>New Project</span></div>`;
  }
  grid.innerHTML = html;
  loadProjectCounts();
}

async function loadProjectCounts() {
  for (const p of projects) {
    try {
      let q = db.from('mind_map_app_assemblies').select('count',{count:'exact',head:true}).eq('project_id',p.id);
      if (!isAdmin) q = q.eq('is_visible',true);
      const { count } = await q;
      const el = document.getElementById(`pCount_${p.id}`);
      if (el) el.textContent = `${count||0} mind map${count===1?'':'s'}`;
    } catch(e) {}
  }
}

async function openProject(id) {
  const project = projects.find(p=>p.id===id);
  if (!project) return;
  currentProject = project;
  document.getElementById('currentProjectIcon').textContent = project.icon||'üß†';
  document.getElementById('currentProjectName').textContent = project.name;
  document.getElementById('currentProjectDesc').textContent = project.description||'No description';
  const ap = document.getElementById('assembliesPage');
  const rgba = hexToRgba(project.color||'#3498db',0.08);
  ap.style.background = `linear-gradient(135deg,${rgba} 0%,#f5f7fa 100%)`;
  await loadAssemblies();
  navigateTo('assemblies');
}

function hexToRgba(hex,a) {
  const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
}

function createNewProject() {
  if (!isAdmin) return;
  const defEmoji = PROJECT_EMOJIS[Math.floor(Math.random()*PROJECT_EMOJIS.length)];
  const defColor = PROJECT_COLORS[Math.floor(Math.random()*PROJECT_COLORS.length)].value;
  const emojiOpts = PROJECT_EMOJIS.map(e=>`<button type="button" onclick="selectProjectEmoji('${e}')" class="${e===defEmoji?'selected':''}">${e}</button>`).join('');
  const colorOpts = PROJECT_COLORS.map(c=>`<button type="button" style="background:${c.value}" onclick="selectProjectColor('${c.value}')" class="${c.value===defColor?'selected':''}" title="${c.name}"></button>`).join('');
  showModal('New Project',`
    <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="projectName" placeholder="Project name"></div>
    <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="projectDesc" placeholder="Description"></textarea></div>
    <div class="form-group"><label class="form-label">Icon</label><div class="emoji-picker">${emojiOpts}</div><input type="hidden" id="projectIcon" value="${defEmoji}"></div>
    <div class="form-group"><label class="form-label">Color</label><div class="color-picker">${colorOpts}</div><input type="hidden" id="projectColor" value="${defColor}"></div>`,
    [{label:'Cancel',class:'btn-secondary',action:hideModal},{label:'Create',class:'btn-primary',action:()=>saveProject(null)}]
  );
  setTimeout(()=>document.getElementById('projectName')?.focus(),100);
}

function editProject(id) {
  if (!isAdmin) return;
  const p = projects.find(x=>x.id===id); if (!p) return;
  const emojiOpts = PROJECT_EMOJIS.map(e=>`<button type="button" onclick="selectProjectEmoji('${e}')" class="${e===p.icon?'selected':''}">${e}</button>`).join('');
  const colorOpts = PROJECT_COLORS.map(c=>`<button type="button" style="background:${c.value}" onclick="selectProjectColor('${c.value}')" class="${c.value===p.color?'selected':''}" title="${c.name}"></button>`).join('');
  showModal('Edit Project',`
    <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="projectName" value="${escapeHtml(p.name)}"></div>
    <div class="form-group"><label class="form-label">Description</label><textarea class="form-textarea" id="projectDesc">${escapeHtml(p.description||'')}</textarea></div>
    <div class="form-group"><label class="form-label">Icon</label><div class="emoji-picker">${emojiOpts}</div><input type="hidden" id="projectIcon" value="${p.icon||'üß†'}"></div>
    <div class="form-group"><label class="form-label">Color</label><div class="color-picker">${colorOpts}</div><input type="hidden" id="projectColor" value="${p.color||'#3498db'}"></div>`,
    [{label:'Cancel',class:'btn-secondary',action:hideModal},{label:'Save',class:'btn-primary',action:()=>saveProject(id)}]
  );
}

async function saveProject(id) {
  const name=document.getElementById('projectName').value.trim();
  const description=document.getElementById('projectDesc').value.trim();
  const icon=document.getElementById('projectIcon').value;
  const color=document.getElementById('projectColor').value;
  if (!name) { showToast('Name required','error'); return; }
  try {
    if (id) {
      const {error} = await db.from('mind_map_app_projects').update({name,description,icon,color,updated_at:new Date().toISOString()}).eq('id',id);
      if (error) throw error;
      showToast('Project updated','success');
    } else {
      const {error} = await db.from('mind_map_app_projects').insert({name,description,icon,color,is_visible:true});
      if (error) throw error;
      showToast('Project created','success');
    }
    hideModal(); await loadProjects();
  } catch(e) { showToast('Error: '+e.message,'error'); }
}

function selectProjectEmoji(emoji) {
  document.getElementById('projectIcon').value=emoji;
  document.querySelectorAll('.emoji-picker button').forEach(b=>b.classList.toggle('selected',b.textContent===emoji));
}

function selectProjectColor(color) {
  document.getElementById('projectColor').value=color;
  document.querySelectorAll('.color-picker button').forEach(b=>{
    const bc=b.style.background;
    const hex=bc.startsWith('#')?bc:rgbToHex(bc);
    b.classList.toggle('selected',hex===color.toLowerCase());
  });
}

function rgbToHex(rgb) {
  if(rgb.startsWith('#'))return rgb.toLowerCase();
  const m=rgb.match(/\d+/g); if(!m||m.length<3)return rgb;
  return '#'+m.slice(0,3).map(x=>parseInt(x).toString(16).padStart(2,'0')).join('');
}

async function toggleProjectVisibility(id,vis) {
  if (!isAdmin) return;
  try {
    await db.from('mind_map_app_projects').update({is_visible:vis}).eq('id',id);
    const p=projects.find(x=>x.id===id); if(p)p.is_visible=vis;
    showToast(`Project ${vis?'visible':'hidden'}`,'success'); renderProjects();
  } catch(e) { showToast('Error','error'); }
}

function confirmDeleteProject(id) {
  if (!isAdmin) return;
  const p=projects.find(x=>x.id===id); if(!p)return;
  showModal('Delete Project',
    `<p>Delete "<strong>${escapeHtml(p.name)}</strong>"?</p><p style="color:#e74c3c;margin-top:10px;font-size:13px;">‚ö†Ô∏è All mind maps and nodes will be deleted!</p>`,
    [{label:'Cancel',class:'btn-secondary',action:hideModal},{label:'Delete',class:'btn-danger',action:()=>deleteProject(id)}]
  );
}

async function deleteProject(id) {
  try {
    const {data:asms} = await db.from('mind_map_app_assemblies').select('id').eq('project_id',id);
    if (asms?.length) {
      const ids=asms.map(a=>a.id);
      await db.from('mind_map_app_links').delete().in('assembly_id',ids);
      await db.from('mind_map_app_nodes').delete().in('assembly_id',ids);
      await db.from('mind_map_app_assemblies').delete().eq('project_id',id);
    }
    await db.from('mind_map_app_projects').delete().eq('id',id);
    hideModal(); showToast('Project deleted','success'); await loadProjects();
  } catch(e) { showToast('Error: '+e.message,'error'); }
}

// ============================================================
// ASSEMBLIES
// ============================================================
async function loadAssemblies() {
  try {
    let q = db.from('mind_map_app_assemblies').select('*').order('name');
    if (currentProject) q=q.eq('project_id',currentProject.id);
    if (!isAdmin) q=q.eq('is_visible',true);
    const {data,error}=await q;
    if (error) throw error;
    assemblies=data||[];
    renderAssemblies();
  } catch(e) { console.error('Load assemblies error:',e); }
}

function renderAssemblies() {
  const grid=document.getElementById('assembliesGrid');
  const color=currentProject?.color||'#3498db';
  let display = isAdmin?[...assemblies]:assemblies.filter(a=>a.is_visible);
  if (isAdmin) display.sort((a,b)=>(a.is_visible===b.is_visible)?0:(a.is_visible?-1:1));
  let html='';
  for (const a of display) {
    const hidden=a.is_visible===false;
    html+=`
      <div class="assembly-card ${hidden?'hidden-assembly':''}" style="border-color:${color}" onclick="openAssembly('${a.id}','${escapeHtml(a.name)}')">
        <h4>${escapeHtml(a.name)}</h4>
        <span class="node-count" id="aCount_${a.id}">Loading...</span>
        ${isAdmin?`<div class="assembly-card-footer">
          <div class="visibility-toggle" onclick="event.stopPropagation()">
            <input type="checkbox" id="aVis_${a.id}" ${a.is_visible!==false?'checked':''} onchange="toggleAssemblyVisibility('${a.id}',this.checked)">
            <label for="aVis_${a.id}"><span class="toggle-switch"></span></label>
          </div>
          <div class="project-card-actions">
            <button class="project-edit-btn" onclick="event.stopPropagation();renameAssemblyById('${a.id}')">‚úèÔ∏è</button>
            <button class="project-delete-btn" onclick="event.stopPropagation();confirmDeleteAssemblyById('${a.id}')">üóëÔ∏è</button>
          </div>
        </div>`:''}
      </div>`;
  }
  if (isAdmin) {
    html+=`<div class="assembly-card add-card" onclick="createNewAssemblyInProject()">
      <span style="font-size:32px;">‚ûï</span><span>New Mind Map</span></div>`;
  }
  grid.innerHTML=html;
  loadAssemblyCounts();
}

async function loadAssemblyCounts() {
  for (const a of assemblies) {
    try {
      const {count}=await db.from('mind_map_app_nodes').select('count',{count:'exact',head:true}).eq('assembly_id',a.id).eq('deleted',false);
      const el=document.getElementById(`aCount_${a.id}`);
      if(el) el.textContent=`${count||0} node${count===1?'':'s'}`;
    } catch(e) {}
  }
}

async function openAssembly(id,name) {
  currentAssemblyId=id; currentAssemblyName=name;
  const sel=document.getElementById('assemblySelect');
  sel.innerHTML=assemblies.map(a=>`<option value="${a.id}" ${a.id===id?'selected':''}>${escapeHtml(a.name)}</option>`).join('');
  navigateTo('tree');
  await loadAssemblyData(id);
}

async function onAssemblyChange() {
  const sel=document.getElementById('assemblySelect');
  const id=sel.value; if(!id) return;
  const a=assemblies.find(x=>x.id===id);
  currentAssemblyId=id; currentAssemblyName=a?.name||'';
  updateBreadcrumb();
  await loadAssemblyData(id);
}

function createNewAssemblyInProject() {
  if (!isAdmin) return;
  showModal('New Mind Map',
    `<div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="newAsmName" placeholder="Mind map name"></div>`,
    [{label:'Cancel',class:'btn-secondary',action:hideModal},{label:'Create',class:'btn-primary',action:saveNewAssembly}]
  );
  setTimeout(()=>document.getElementById('newAsmName')?.focus(),100);
}

function createNewAssemblyInTree() { createNewAssemblyInProject(); }

async function saveNewAssembly() {
  const name=document.getElementById('newAsmName').value.trim();
  if (!name) { showToast('Name required','error'); return; }
  try {
    const {data:newAsm,error:aErr}=await db.from('mind_map_app_assemblies').insert({name,project_id:currentProject?.id,is_visible:true}).select().single();
    if (aErr) throw aErr;
    // Create root node
    await db.from('mind_map_app_nodes').insert({assembly_id:newAsm.id,name:name,status:'NOT_STARTED',x:600,y:300});
    showToast(`"${name}" created`,'success'); hideModal();
    await loadAssemblies();
  } catch(e) { showToast('Error: '+e.message,'error'); }
}

function renameAssemblyById(id) {
  if (!isAdmin) return;
  const a=assemblies.find(x=>x.id===id); if(!a)return;
  showModal('Rename Mind Map',
    `<div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="renameAsmInput" value="${escapeHtml(a.name)}"></div>`,
    [{label:'Cancel',class:'btn-secondary',action:hideModal},{label:'Rename',class:'btn-primary',action:()=>doRenameAssembly(id)}]
  );
  setTimeout(()=>{const i=document.getElementById('renameAsmInput');i?.focus();i?.select();},100);
}

function renameCurrentAssembly() { if(currentAssemblyId) renameAssemblyById(currentAssemblyId); }

async function doRenameAssembly(id) {
  const name=document.getElementById('renameAsmInput').value.trim();
  if (!name) { showToast('Name required','error'); return; }
  try {
    await db.from('mind_map_app_assemblies').update({name}).eq('id',id);
    hideModal(); showToast('Renamed','success'); await loadAssemblies();
    if(currentAssemblyId===id){currentAssemblyName=name;updateBreadcrumb();}
  } catch(e) { showToast('Error','error'); }
}

async function toggleAssemblyVisibility(id,vis) {
  if (!isAdmin) return;
  try {
    await db.from('mind_map_app_assemblies').update({is_visible:vis}).eq('id',id);
    const a=assemblies.find(x=>x.id===id); if(a)a.is_visible=vis;
    showToast(`${vis?'Visible':'Hidden'}`,'success'); renderAssemblies();
  } catch(e) { showToast('Error','error'); }
}

function confirmDeleteAssemblyById(id) {
  if (!isAdmin) return;
  const a=assemblies.find(x=>x.id===id); if(!a)return;
  showModal('Delete Mind Map',
    `<p>Delete "<strong>${escapeHtml(a.name)}</strong>"?</p><p style="color:#e74c3c;font-size:13px;margin-top:10px;">‚ö†Ô∏è All nodes and links will be deleted!</p>`,
    [{label:'Cancel',class:'btn-secondary',action:hideModal},{label:'Delete',class:'btn-danger',action:()=>doDeleteAssembly(id)}]
  );
}

function confirmDeleteCurrentAssembly() { if(currentAssemblyId) confirmDeleteAssemblyById(currentAssemblyId); }

async function doDeleteAssembly(id) {
  try {
    await db.from('mind_map_app_links').delete().eq('assembly_id',id);
    await db.from('mind_map_app_nodes').delete().eq('assembly_id',id);
    await db.from('mind_map_app_assemblies').delete().eq('id',id);
    hideModal(); showToast('Deleted','success');
    if(currentPage==='tree' && currentAssemblyId===id) navigateTo('assemblies');
    await loadAssemblies();
  } catch(e) { showToast('Error: '+e.message,'error'); }
}

// ============================================================
// TREE DATA & RENDERING
// ============================================================
async function loadAssemblyData(assemblyId) {
  showLoading(true); setStatus('Loading...','loading');
  try {
    const {data:nodeData,error:nErr}=await db.from('mind_map_app_nodes').select('*').eq('assembly_id',assemblyId).eq('deleted',false);
    if(nErr)throw nErr;
    const {data:linkData,error:lErr}=await db.from('mind_map_app_links').select('*').eq('assembly_id',assemblyId).eq('deleted',false);
    if(lErr)throw lErr;
    nodes=nodeData||[];
    links=linkData||[];

    // Compute levels
    computeLevels();
    renderGraph();
    setStatus(`${nodes.length} nodes`,'success');
  } catch(e) {
    console.error('Load assembly data error:',e);
    setStatus('Load failed','error');
  }
  showLoading(false);
}

function computeLevels() {
  // Build adjacency
  const childToParents={};
  const parentToChildren={};
  links.forEach(l=>{
    if(!childToParents[l.child_id]) childToParents[l.child_id]=[];
    childToParents[l.child_id].push(l.parent_id);
    if(!parentToChildren[l.parent_id]) parentToChildren[l.parent_id]=[];
    parentToChildren[l.parent_id].push(l.child_id);
  });

  // Find roots (no parents)
  const roots=nodes.filter(n=>!childToParents[n.id]||childToParents[n.id].length===0);

  // BFS to assign levels
  nodes.forEach(n=>n.level=0);
  const queue=[...roots.map(r=>({id:r.id,level:1}))];
  const visited=new Set();
  while(queue.length) {
    const {id,level}=queue.shift();
    if(visited.has(id)) continue;
    visited.add(id);
    const node=nodes.find(n=>n.id===id);
    if(node) node.level=level;
    (parentToChildren[id]||[]).forEach(childId=>{
      if(!visited.has(childId)) queue.push({id:childId,level:level+1});
    });
  }
  // Orphans
  nodes.forEach(n=>{if(!visited.has(n.id))n.level=1;});

  // Store relationships on nodes
  nodes.forEach(n=>{
    n.goesInto=childToParents[n.id]||[];
    n.receivesFrom=parentToChildren[n.id]||[];
  });
}

function renderGraph() {
  const svg=d3.select('#treeSvg');
  svg.selectAll('*').remove();

  const container=document.getElementById('treeContainer');
  const width=Math.max(container.clientWidth,1200);
  const height=Math.max(container.clientHeight,800);
  svg.attr('width',width).attr('height',height);

  const g=svg.append('g');

  // Zoom
  const zoom=d3.zoom().scaleExtent([0.1,4]).on('zoom',(e)=>g.attr('transform',e.transform));
  svg.call(zoom);

  const colorMode=document.getElementById('colorMode')?.value||'level';

  // Draw links
  const linkGroup=g.append('g').attr('class','links');
  linkGroup.selectAll('line').data(links).enter().append('line')
    .attr('class','link')
    .attr('stroke','#999').attr('stroke-opacity',0.6)
    .attr('x1',d=>{const n=nodes.find(x=>x.id===d.parent_id);return n?n.x:0;})
    .attr('y1',d=>{const n=nodes.find(x=>x.id===d.parent_id);return n?n.y:0;})
    .attr('x2',d=>{const n=nodes.find(x=>x.id===d.child_id);return n?n.x:0;})
    .attr('y2',d=>{const n=nodes.find(x=>x.id===d.child_id);return n?n.y:0;});

  // Draw nodes
  const nodeGroup=g.append('g').attr('class','nodes');
  const nodeEls=nodeGroup.selectAll('g.node').data(nodes,d=>d.id).enter().append('g')
    .attr('class','node')
    .attr('transform',d=>`translate(${d.x||0},${d.y||0})`);

  // Node rectangles
  nodeEls.append('rect')
    .attr('class','node-shape')
    .attr('width',d=>Math.max(80,d.name.length*8+20))
    .attr('height',36)
    .attr('x',d=>-Math.max(80,d.name.length*8+20)/2)
    .attr('y',-18)
    .attr('rx',8).attr('ry',8)
    .attr('fill',d=>getNodeColor(d,colorMode))
    .attr('stroke',d=>d3.color(getNodeColor(d,colorMode))?.darker(0.3)||'#666')
    .attr('stroke-width',1.5);

  // Status dot
  nodeEls.append('circle')
    .attr('class','status-dot')
    .attr('cx',d=>-Math.max(80,d.name.length*8+20)/2+8)
    .attr('cy',-8)
    .attr('r',4)
    .attr('fill',d=>(STATUS_COLORS[d.status]||STATUS_COLORS.NOT_STARTED).fill)
    .attr('stroke','white').attr('stroke-width',1);

  // Labels
  nodeEls.append('text')
    .attr('class','node-label')
    .attr('text-anchor','middle').attr('dy','0.35em')
    .attr('font-size',d=>Math.max(10,13-Math.floor((d.level||1)/2)))
    .attr('fill','#333')
    .text(d=>d.name.length>20?d.name.substring(0,18)+'‚Ä¶':d.name);

  // Drag behavior (admin only)
  if (isAdmin) {
    const drag=d3.drag()
      .on('start',function(e,d){d3.select(this).raise();})
      .on('drag',function(e,d){
        d.x=e.x; d.y=e.y;
        d3.select(this).attr('transform',`translate(${d.x},${d.y})`);
        updateLinks();
      });
    nodeEls.call(drag);
  }

  // Click & right-click
  nodeEls.on('click',function(e,d){
    e.stopPropagation();
    selectedNode=d;
    openSidePanel(d);
  });

  if (isAdmin) {
    nodeEls.on('contextmenu',function(e,d){
      e.preventDefault(); e.stopPropagation();
      showContextMenu(e.pageX,e.pageY,d);
    });
  }

  // Click background to deselect
  svg.on('click',()=>{selectedNode=null;closeSidePanel();hideContextMenu();});

  // Force simulation
  if (simulation) simulation.stop();

  // Only run force for nodes without saved positions
  const needsLayout = nodes.some(n=>n.x===0 && n.y===0);
  if (needsLayout) {
    simulation = d3.forceSimulation(nodes)
      .force('link', d3.forceLink(links.map(l=>({source:nodes.findIndex(n=>n.id===l.parent_id),target:nodes.findIndex(n=>n.id===l.child_id)}))).distance(120))
      .force('charge', d3.forceManyBody().strength(-300))
      .force('center', d3.forceCenter(width/2, height/2))
      .force('y', d3.forceY().y(d=>d.level*120).strength(0.3))
      .on('tick', () => {
        nodeEls.attr('transform',d=>`translate(${d.x},${d.y})`);
        updateLinks();
      });

    setTimeout(()=>{if(simulation)simulation.stop();},3000);
  }

  function updateLinks() {
    linkGroup.selectAll('line')
      .attr('x1',d=>{const n=nodes.find(x=>x.id===d.parent_id);return n?n.x:0;})
      .attr('y1',d=>{const n=nodes.find(x=>x.id===d.parent_id);return n?n.y:0;})
      .attr('x2',d=>{const n=nodes.find(x=>x.id===d.child_id);return n?n.x:0;})
      .attr('y2',d=>{const n=nodes.find(x=>x.id===d.child_id);return n?n.y:0;});
  }
}

function getNodeColor(node, mode) {
  if (mode==='status') return (STATUS_COLORS[node.status]||STATUS_COLORS.NOT_STARTED).bg;
  if (mode==='priority') {
    const p=node.priority||'MEDIUM';
    if(p==='HIGH') return '#fdedec';
    if(p==='LOW') return '#ebf5fb';
    return '#fef9e7';
  }
  // level
  return LEVEL_COLORS[Math.min((node.level||1)-1,7)];
}

function refreshLayout() {
  nodes.forEach(n=>{n.x=0;n.y=0;});
  renderGraph();
}

async function saveAllPositions() {
  if (!isAdmin) return;
  setStatus('Saving...','loading');
  try {
    for (const n of nodes) {
      await db.from('mind_map_app_nodes').update({x:n.x,y:n.y}).eq('id',n.id);
    }
    setStatus('Saved!','success');
    showToast('Positions saved','success');
  } catch(e) { setStatus('Save failed','error'); showToast('Save error','error'); }
}

// ============================================================
// SIDE PANEL (Edit Node)
// ============================================================
function openSidePanel(node) {
  document.getElementById('panelTitle').textContent = 'Edit Node';
  document.getElementById('panelContent').innerHTML = `
    <div class="form-group"><label class="form-label">Name</label><input type="text" class="form-input" id="editName" value="${escapeHtml(node.name)}"></div>
    <div class="form-row">
      <div class="form-group"><label class="form-label">Status</label>
        <select class="form-select" id="editStatus">
          <option value="NOT_STARTED" ${node.status==='NOT_STARTED'?'selected':''}>Not Started</option>
          <option value="IN_PROGRESS" ${node.status==='IN_PROGRESS'?'selected':''}>In Progress</option>
          <option value="DONE" ${node.status==='DONE'?'selected':''}>Done</option>
          <option value="BLOCKED" ${node.status==='BLOCKED'?'selected':''}>Blocked</option>
        </select>
      </div>
      <div class="form-group"><label class="form-label">Priority</label>
        <select class="form-select" id="editPriority">
          <option value="LOW" ${node.priority==='LOW'?'selected':''}>Low</option>
          <option value="MEDIUM" ${node.priority==='MEDIUM'?'selected':''}>Medium</option>
          <option value="HIGH" ${node.priority==='HIGH'?'selected':''}>High</option>
        </select>
      </div>
    </div>
    <div class="form-group"><label class="form-label">Tags</label><input type="text" class="form-input" id="editTags" value="${escapeHtml(node.tags||'')}" placeholder="comma separated"></div>
    <div class="form-group"><label class="form-label">Notes</label><textarea class="form-textarea" id="editNotes">${escapeHtml(node.notes||'')}</textarea></div>
    <div class="form-group" style="font-size:11px;color:#95a5a6;">Level: ${node.level} | ID: ${node.id.substring(0,8)}...</div>
  `;

  const footer = document.getElementById('panelFooter');
  if (isAdmin) {
    footer.innerHTML = `<button class="btn btn-primary" onclick="saveNodeEdit('${node.id}')">üíæ Save</button>
      <button class="btn btn-danger" onclick="confirmDeleteNode('${node.id}')">üóëÔ∏è Delete</button>`;
  } else {
    footer.innerHTML = `<p style="font-size:11px;color:#95a5a6;">View only</p>`;
  }

  document.getElementById('sidePanel').classList.add('open');
}

function closeSidePanel() { document.getElementById('sidePanel').classList.remove('open'); }

async function saveNodeEdit(id) {
  if (!isAdmin) return;
  const name=document.getElementById('editName').value.trim();
  const status=document.getElementById('editStatus').value;
  const priority=document.getElementById('editPriority').value;
  const tags=document.getElementById('editTags').value.trim();
  const notes=document.getElementById('editNotes').value.trim();
  if (!name) { showToast('Name required','error'); return; }
  try {
    await db.from('mind_map_app_nodes').update({name,status,priority,tags,notes}).eq('id',id);
    const n=nodes.find(x=>x.id===id);
    if(n){n.name=name;n.status=status;n.priority=priority;n.tags=tags;n.notes=notes;}
    renderGraph(); closeSidePanel();
    showToast('Node updated','success');
  } catch(e) { showToast('Error: '+e.message,'error'); }
}

function confirmDeleteNode(id) {
  showModal('Delete Node',`<p>Delete this node and all its links?</p>`,
    [{label:'Cancel',class:'btn-secondary',action:hideModal},{label:'Delete',class:'btn-danger',action:()=>doDeleteNode(id)}]
  );
}

async function doDeleteNode(id) {
  try {
    await db.from('mind_map_app_links').delete().or(`parent_id.eq.${id},child_id.eq.${id}`);
    await db.from('mind_map_app_nodes').update({deleted:true}).eq('id',id);
    nodes=nodes.filter(n=>n.id!==id);
    links=links.filter(l=>l.parent_id!==id && l.child_id!==id);
    computeLevels(); renderGraph(); closeSidePanel(); hideModal();
    showToast('Node deleted','success');
  } catch(e) { showToast('Error','error'); }
}

// ============================================================
// CONTEXT MENU
// ============================================================
function showContextMenu(x,y,node) {
  const menu=document.getElementById('contextMenu');
  menu.innerHTML=`
    <div class="context-menu-item" onclick="addChildNode('${node.id}')"><span>‚ûï</span> Add Child</div>
    <div class="context-menu-item" onclick="addSiblingNode('${node.id}')"><span>‚ÜîÔ∏è</span> Add Sibling</div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item" onclick="openSidePanel(nodes.find(n=>n.id==='${node.id}'));hideContextMenu()"><span>‚úèÔ∏è</span> Edit</div>
    <div class="context-menu-divider"></div>
    <div class="context-menu-item danger" onclick="confirmDeleteNode('${node.id}');hideContextMenu()"><span>üóëÔ∏è</span> Delete</div>
  `;
  menu.style.left=x+'px'; menu.style.top=y+'px';
  menu.classList.add('show');
}

function hideContextMenu() { document.getElementById('contextMenu').classList.remove('show'); }
document.addEventListener('click',()=>hideContextMenu());

async function addChildNode(parentId) {
  hideContextMenu();
  const name=prompt('Child node name:');
  if(!name) return;
  try {
    const parent=nodes.find(n=>n.id===parentId);
    const {data:newNode,error:nErr}=await db.from('mind_map_app_nodes').insert({
      assembly_id:currentAssemblyId,name,status:'NOT_STARTED',priority:'MEDIUM',
      x:(parent?.x||0)+150, y:(parent?.y||0)+80
    }).select().single();
    if(nErr) throw nErr;
    const {error:lErr}=await db.from('mind_map_app_links').insert({
      assembly_id:currentAssemblyId,parent_id:parentId,child_id:newNode.id
    });
    if(lErr) throw lErr;
    await loadAssemblyData(currentAssemblyId);
    showToast('Child added','success');
  } catch(e) { showToast('Error: '+e.message,'error'); }
}

async function addSiblingNode(nodeId) {
  hideContextMenu();
  const name=prompt('Sibling node name:');
  if(!name) return;
  try {
    const node=nodes.find(n=>n.id===nodeId);
    const parentLink=links.find(l=>l.child_id===nodeId);
    const {data:newNode,error:nErr}=await db.from('mind_map_app_nodes').insert({
      assembly_id:currentAssemblyId,name,status:'NOT_STARTED',priority:'MEDIUM',
      x:(node?.x||0)+150, y:(node?.y||0)
    }).select().single();
    if(nErr) throw nErr;
    if(parentLink) {
      await db.from('mind_map_app_links').insert({
        assembly_id:currentAssemblyId,parent_id:parentLink.parent_id,child_id:newNode.id
      });
    }
    await loadAssemblyData(currentAssemblyId);
    showToast('Sibling added','success');
  } catch(e) { showToast('Error: '+e.message,'error'); }
}

// ============================================================
// CHATBOT
// ============================================================
let chatProcessing = false;

function toggleChatPanel() {
  const p=document.getElementById('chatPanel');
  p.classList.toggle('open');
  if(p.classList.contains('open')) document.getElementById('chatInput').focus();
}

function closeChatPanel() { document.getElementById('chatPanel').classList.remove('open'); }

function addChatMessage(role,content) {
  const msgs=document.getElementById('chatMessages');
  const div=document.createElement('div');
  div.className=`chat-message ${role}`;
  div.innerHTML=`<div class="chat-bubble ${role}">${content}</div>`;
  msgs.appendChild(div);
  msgs.scrollTop=msgs.scrollHeight;
}

function quickAction(type) {
  const map={status:"What's the status?",blocked:"What's blocked?",progress:'Show progress',next:'What can I work on?'};
  document.getElementById('chatInput').value=map[type]||'Help';
  sendChatMessage();
}

async function sendChatMessage() {
  const input=document.getElementById('chatInput');
  const msg=input.value.trim();
  if(!msg || chatProcessing) return;
  addChatMessage('user',escapeHtml(msg));
  input.value='';
  chatProcessing=true;
  try {
    const response=processChatQuery(msg);
    addChatMessage('assistant',response);
  } catch(e) {
    addChatMessage('assistant','‚ùå Error processing request.');
  }
  chatProcessing=false;
}

function processChatQuery(query) {
  const q=query.toLowerCase();
  if(nodes.length===0) return 'üì≠ No data loaded. Select a mind map first.';
  if(q.includes('status')||q.includes('overview')||q.includes('summary')) return chatStatus();
  if(q.includes('block')||q.includes('stuck')) return chatBlocked();
  if(q.includes('progress')||q.includes('complete')||q.includes('done')) return chatProgress();
  if(q.includes('work on')||q.includes('next')||q.includes('parallel')||q.includes('start')) return chatNext();
  if(q.includes('priority')||q.includes('critical')||q.includes('urgent')) return chatPriority();
  return chatHelp();
}

function chatStatus() {
  const total=nodes.length;
  const counts={DONE:0,IN_PROGRESS:0,NOT_STARTED:0,BLOCKED:0};
  nodes.forEach(n=>{ if(counts[n.status]!==undefined)counts[n.status]++; else counts.NOT_STARTED++; });
  const pct=Math.round((counts.DONE/total)*100);
  return fmt(`üìä <strong>Status: ${currentAssemblyName}</strong><br><br>
    Total: <strong>${total}</strong> nodes | Completion: <strong>${pct}%</strong><br><br>
    ‚úÖ Done: ${counts.DONE}<br>üîÑ In Progress: ${counts.IN_PROGRESS}<br>
    ‚è∏Ô∏è Not Started: ${counts.NOT_STARTED}<br>üö´ Blocked: ${counts.BLOCKED}`);
}

function chatBlocked() {
  const blocked=nodes.filter(n=>n.status==='BLOCKED');
  if(!blocked.length) return '‚úÖ No blocked items!';
  let r=`üö´ <strong>Blocked Items (${blocked.length})</strong><br><br>`;
  blocked.forEach(n=>{ r+=`‚Ä¢ <strong>${escapeHtml(n.name)}</strong> (L${n.level})${n.notes?'<br>&nbsp;&nbsp;üìù '+escapeHtml(n.notes):''}<br>`; });
  return r;
}

function chatProgress() {
  const total=nodes.length;
  const done=nodes.filter(n=>n.status==='DONE').length;
  const pct=Math.round((done/total)*100);
  let r=`üìà <strong>Progress: ${done}/${total} (${pct}%)</strong><br><br>`;
  const levels={};
  nodes.forEach(n=>{ if(!levels[n.level])levels[n.level]={total:0,done:0}; levels[n.level].total++; if(n.status==='DONE')levels[n.level].done++; });
  Object.keys(levels).sort().forEach(l=>{
    const p=levels[l];
    const lp=Math.round((p.done/p.total)*100);
    r+=`L${l}: ${'‚ñà'.repeat(Math.round(lp/10))}${'‚ñë'.repeat(10-Math.round(lp/10))} ${p.done}/${p.total} (${lp}%)<br>`;
  });
  return r;
}

function chatNext() {
  const workable=nodes.filter(n=>{
    if(n.status==='DONE'||n.status==='BLOCKED') return false;
    return (n.receivesFrom||[]).every(cId=>{
      const c=nodes.find(x=>x.id===cId); return !c||c.status==='DONE';
    });
  }).sort((a,b)=>(b.level||1)-(a.level||1));
  if(!workable.length) return 'üîí All available work is blocked or complete.';
  let r=`üöÄ <strong>Available Work (${workable.length})</strong><br><br>`;
  workable.slice(0,10).forEach(n=>{
    const icon=n.priority==='HIGH'?'üî¥':n.priority==='LOW'?'üîµ':'üü°';
    r+=`${icon} <strong>${escapeHtml(n.name)}</strong> (L${n.level})<br>`;
  });
  if(workable.length>10) r+=`<br>...and ${workable.length-10} more`;
  return r;
}

function chatPriority() {
  const high=nodes.filter(n=>n.priority==='HIGH' && n.status!=='DONE');
  if(!high.length) return '‚úÖ No high-priority items pending!';
  let r=`üî¥ <strong>High Priority (${high.length})</strong><br><br>`;
  high.forEach(n=>{
    const icon=n.status==='BLOCKED'?'üö´':n.status==='IN_PROGRESS'?'üîÑ':'‚¨ú';
    r+=`${icon} <strong>${escapeHtml(n.name)}</strong> (L${n.level})<br>`;
  });
  return r;
}

function chatHelp() {
  return `ü§ñ <strong>Mind Map Assistant</strong><br><br>
    Try asking:<br>
    ‚Ä¢ <strong>"Status"</strong> - Overall summary<br>
    ‚Ä¢ <strong>"Blocked"</strong> - Find blocked items<br>
    ‚Ä¢ <strong>"Progress"</strong> - Progress by level<br>
    ‚Ä¢ <strong>"What's next"</strong> - Available work<br>
    ‚Ä¢ <strong>"Priority"</strong> - High priority items`;
}

function fmt(s) { return s; }

// ============================================================
// INIT ON LOAD
// ============================================================
window.addEventListener('load', init);
window.addEventListener('load', () => setTimeout(initGoogleAuth, 1000));
</script>
</body>
</html>
